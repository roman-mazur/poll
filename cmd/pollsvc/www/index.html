<!DOCTYPE html>
<html lang="en">
<head>
  <title>poll</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />
  <style lang="css">
    .the-end {
       display: none;
    }
    .poll {
        padding: 50px 0;
    }
    #question {
        margin-bottom: 50px;
    }
    .poll a {
        padding: 40px 20px;
    }
  </style>
</head>

<body>

  <section class="poll card blue-grey darken-1">
    <div class="card-content white-text">
      <h2 class="card-title center" id="question">Do you agree with the speaker?</h2>
      <div class="card-action center">
        <a id="choice-negative" href="#">No</a>
        <a id="choice-positive" href="#">Yes</a>
      </div>
    </div>
  </section>

  <section class="the-end card deep-orange" id="the-end">
    <div class="card-content center white-text">
      <h3>Thanks for your participation!</h3>
      <p>That's it.</p>
    </div>
  </section>

  <script>
    const questions = [
      {q: 'Do you agree with the speaker?', neg: 'No', pos: 'Yes'},
      {q: 'Does it make sense?', neg: 'Not to me', pos: 'Sure'},
    ];

    const deadline = Date.now() + 1000*60; // TODO.

    function init(talkId) {
      if (Date.now() >= deadline) {
        let pollElements = document.getElementsByClassName('poll');
        for (let i = 0; i < pollElements.length; i++) {
          pollElements[i].style.display = 'none';
        }
        document.getElementById('the-end').style.display = 'block';
      }

      const idx = Math.floor(Math.random()*questions.length);
      const variant = questions[idx];

      const qEl = document.getElementById('question');
      qEl.innerText = variant.q;

      const choiceNeg = document.getElementById('choice-negative');
      choiceNeg.innerText = variant.neg;
      choiceNeg.onclick = () => {
        submitChoice(talkId, 1);
      };

      const choicePos = document.getElementById('choice-positive');
      choicePos.innerText = variant.pos;
      choicePos.onclick = () => {
        submitChoice(talkId, 10);
      };
    }

    async function submitChoice(talk, val) {
      const resp = await fetch('/v1/votes', {
        method: 'POST',
        body: JSON.stringify({
          talk_name: talk,
          value: val,
          voter_id: voterId(),
        })
      });
      return await resp.json();
    }

    async function currentTalkId() {
      console.log(window.location.search);
      const sp = new URLSearchParams(window.location.search);
      return sp.get('id');
    }

    function voterId() {
      const key = 'vid/v2';
      let res = localStorage.getItem(key);
      if (!res) {
        res = Math.round(Math.random() * 1000000000).toString(16);
        localStorage.setItem(key, res);
      }
      return res;
    }

    currentTalkId().then(id => {
      const reInit = () => init(id);
      reInit();
      //const period = 1000*60*3; // TODO
      const period = 1000;
      window.setInterval(reInit, period);
    });

  </script>

</body>
</html>
